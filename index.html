<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StartCall Ultimate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root { --primary: #2962ff; --accent: #00d4ff; --bg: #050505; --card: #151515; --text: #fff; }
        
        /* THEMES */
        body.t1 { --bg: #050505; --card: #111; --accent: #00d4ff; }
        body.t2 { --bg: #1a0005; --card: #2b0009; --accent: #ff0055; }
        body.t3 { --bg: #001b05; --card: #00290a; --accent: #00c853; }
        body.t4 { --bg: #0d001a; --card: #18002e; --accent: #aa00ff; }
        body.t5 { --bg: #1a0a00; --card: #2e1200; --accent: #ff6d00; }

        /* ANIMATED PARTICLES (FIXED) */
        #particles { position: fixed; inset: 0; pointer-events: none; z-index: -1; overflow: hidden; }
        .particle {
            position: absolute; border-radius: 50%; opacity: 0.5;
            background: var(--accent); box-shadow: 0 0 10px var(--accent);
            animation: float 15s infinite linear; bottom: -50px;
        }
        @keyframes float {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-120vh) scale(1.5); opacity: 0; }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: 0.5s; }

        /* UI ELEMENTS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; margin-bottom: 10px; }
        .btn-sm { padding: 8px 12px; width: auto; font-size: 14px; margin: 0; }
        .btn-icon { width: 40px; height: 40px; border-radius: 50%; border: none; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .vid-btn { background: #2962ff; box-shadow: 0 0 10px rgba(41, 98, 255, 0.5); }
        .aud-btn { background: #00c853; box-shadow: 0 0 10px rgba(0, 200, 83, 0.5); }
        .end-btn { background: #ff1744; box-shadow: 0 0 10px rgba(255, 23, 68, 0.5); }

        input { width: 100%; padding: 15px; margin-bottom: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; outline: none; }
        
        .screen { display: none; height: 100%; flex-direction: column; padding: 20px; position: relative; }
        .screen.active { display: flex; animation: fade 0.4s ease; }
        @keyframes fade { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* DASHBOARD */
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #222; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 22px; }
        
        .tabs { display: flex; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; color: #888; cursor: pointer; transition: 0.3s; border-radius: 8px; }
        .tab.active { background: rgba(255,255,255,0.1); color: white; font-weight: bold; }

        .list { overflow-y: auto; flex: 1; padding-bottom: 80px; }
        .card { display: flex; align-items: center; justify-content: space-between; background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); }

        /* CALL OVERLAY */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; }
        .vid-box { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #remote-vid { width: 100%; height: 100%; object-fit: cover; }
        #local-vid { position: absolute; bottom: 120px; right: 20px; width: 100px; height: 140px; background: #333; border-radius: 10px; border: 2px solid var(--accent); object-fit: cover; z-index: 2; }
        
        .voice-ui { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3; }
        .voice-wave { width: 150px; height: 150px; border-radius: 50%; border: 3px solid var(--accent); display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        .controls { padding: 30px; background: rgba(0,0,0,0.8); display: flex; justify-content: space-around; align-items: center; width: 100%; border-radius: 20px 20px 0 0; position: absolute; bottom: 0; z-index: 10; }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 22px; color: white; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); cursor: pointer; }

        /* PERMISSION MODAL */
        #perm-modal { position: fixed; inset: 0; background: #000; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        
        /* GAME & SETTINGS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        canvas { background: #111; border: 2px solid var(--accent); border-radius: 10px; max-width: 100%; }
    </style>
</head>
<body class="t1">

    <div id="particles"></div>

    <audio id="ring" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="end" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3"></audio>

    <div id="perm-modal">
        <div style="font-size:60px; margin-bottom:20px;">üîí</div>
        <h2>Setup Permissions</h2>
        <p style="color:#888; margin-bottom:30px;">We need Microphone, Camera & Autoplay access for calls to work perfectly.</p>
        <button class="btn" onclick="grantPermissions()">Allow & Start App</button>
    </div>

    <div id="auth-screen" class="screen">
        <h1 style="background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 40px; margin-bottom: 10px;">StartCall</h1>
        <p style="color:#888; margin-bottom: 40px;">Ultimate Calling Experience</p>
        <input type="text" id="u-name" placeholder="Display Name">
        <input type="email" id="u-email" placeholder="Email Address">
        <input type="password" id="u-pass" placeholder="Password">
        <button class="btn" onclick="authHandler()">Enter Dashboard</button>
        <p id="auth-msg" style="color:#ff1744; margin-top:10px; font-size:12px;"></p>
    </div>

    <div id="dashboard" class="screen">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="avatar" id="my-ava">üòé</div>
                <div><h3 id="my-name">User</h3><span style="font-size:10px; color:#00c853;">‚óè Online</span></div>
            </div>
            <div style="display:flex; gap:15px;">
                <i class="fas fa-gamepad" onclick="startGame()" style="font-size:24px; color:var(--accent);"></i>
                <i class="fas fa-cog" onclick="showSettings()" style="font-size:24px; color:#888;"></i>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="tab('friends')">Friends</div>
            <div class="tab" onclick="tab('requests')">Requests <span id="req-badge" style="color:red; display:none;">‚óè</span></div>
            <div class="tab" onclick="tab('search')">Search</div>
        </div>

        <div id="list-friends" class="list"></div>
        <div id="list-requests" class="list" style="display:none;"></div>
        <div id="list-search" class="list" style="display:none;">
            <input type="text" placeholder="Search user..." onkeyup="doSearch(this.value)">
            <div id="search-res"></div>
        </div>
    </div>

    <div id="call-ui">
        <div class="vid-box">
            <video id="remote-vid" autoplay playsinline></video>
            <video id="local-vid" autoplay playsinline muted></video>
            
            <div id="voice-only" class="voice-ui" style="display:none;">
                <div class="voice-wave"><div class="avatar" style="width:80px; height:80px; font-size:30px;" id="call-ava">üë§</div></div>
                <h2 id="call-user" style="margin-top:20px;">Unknown</h2>
                <p id="call-status" style="color:#888;">Connecting...</p>
            </div>
        </div>

        <div class="controls">
            <div id="inc-btns" style="display:none; gap:20px;">
                <button class="ctrl-btn end-btn" onclick="endCall()"><i class="fas fa-times"></i></button>
                <button class="ctrl-btn aud-btn" onclick="answerCall()"><i class="fas fa-phone"></i></button>
            </div>
            <div id="act-btns" style="display:none; width:100%; justify-content:space-between;">
                <button class="ctrl-btn" onclick="toggleMute(this)"><i class="fas fa-microphone"></i></button>
                <button class="ctrl-btn" id="cam-toggle" onclick="toggleCam(this)"><i class="fas fa-video"></i></button>
                <button class="ctrl-btn end-btn" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
                <button class="ctrl-btn" onclick="switchCam()"><i class="fas fa-sync"></i></button>
            </div>
        </div>
    </div>

    <div id="game-modal" class="modal">
        <div style="display:flex; justify-content:space-between; width:300px; margin-bottom:10px;">
            <h3 style="color:var(--accent);">Space Glider</h3>
            <span onclick="closeGame()" style="font-size:24px;">&times;</span>
        </div>
        <canvas id="g-can" width="320" height="480"></canvas>
        <p>Tap to Fly ‚Ä¢ Dodge Meteors</p>
        <h2 id="g-score" style="margin-top:10px;">Score: 0</h2>
    </div>

    <div id="set-modal" class="modal" style="background:var(--bg); justify-content:flex-start; padding:30px;">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2>Settings</h2>
            <i class="fas fa-times" onclick="showSettings()" style="font-size:24px;"></i>
        </div>
        <p>Select Theme:</p>
        <div style="display:grid; grid-template-columns:repeat(5,1fr); gap:10px; width:100%; margin-bottom:30px;">
            <div onclick="setTheme(1)" style="height:40px; background:#2962ff; border-radius:8px;"></div>
            <div onclick="setTheme(2)" style="height:40px; background:#ff0055; border-radius:8px;"></div>
            <div onclick="setTheme(3)" style="height:40px; background:#00c853; border-radius:8px;"></div>
            <div onclick="setTheme(4)" style="height:40px; background:#aa00ff; border-radius:8px;"></div>
            <div onclick="setTheme(5)" style="height:40px; background:#ff6d00; border-radius:8px;"></div>
        </div>
        <button class="btn btn-end" onclick="auth.signOut();location.reload()">Log Out</button>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBruCpy7s-J_uRIyJWWXrJ8M6JT2dqpYD4",
            authDomain: "starcall-9b11e.firebaseapp.com",
            projectId: "starcall-9b11e",
            storageBucket: "starcall-9b11e.firebasestorage.app",
            messagingSenderId: "380174170098",
            appId: "1:380174170098:web:ad6eceb05beac044cddd6b"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let user = null, peer = null, localStream = null, currCall = null, dataConn = null;
        let isVideoCall = true;

        // --- 1. PERMISSIONS & INIT ---
        async function grantPermissions() {
            try {
                // Force User Interaction to unlock AudioContext
                await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                document.getElementById('perm-modal').style.display = 'none';
                
                // Init Particles
                initParticles();
                
                // Check Login
                auth.onAuthStateChanged(u => {
                    if(u) { user = u; loadDash(); }
                    else { show('auth-screen'); }
                });
            } catch(e) {
                alert("Please Allow Microphone & Camera to use the App!");
            }
        }

        // --- 2. AUTH ---
        async function authHandler() {
            const email = document.getElementById('u-email').value;
            const pass = document.getElementById('u-pass').value;
            const name = document.getElementById('u-name').value;
            const msg = document.getElementById('auth-msg');

            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch(e) {
                if(name) {
                    try {
                        const cred = await auth.createUserWithEmailAndPassword(email, pass);
                        await db.collection('users').doc(cred.user.uid).set({
                            name: name, email: email, uid: cred.user.uid, emoji: "üòé", friends: [], isOnline: true
                        });
                        msg.innerText = "Account Created!";
                    } catch(err) { msg.innerText = err.message; }
                } else { msg.innerText = "Enter Name for New Account / Login Failed"; }
            }
        }

        // --- 3. DASHBOARD & PEER ---
        function loadDash() {
            show('dashboard');
            db.collection('users').doc(user.uid).get().then(d => {
                document.getElementById('my-name').innerText = d.data().name;
            });
            
            // ROBUST PEER CONFIG (STUN SERVERS)
            peer = new Peer(user.uid, {
                config: { iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]}
            });

            peer.on('call', call => {
                currCall = call;
                document.getElementById('call-ui').style.display = 'flex';
                document.getElementById('inc-btns').style.display = 'flex';
                document.getElementById('act-btns').style.display = 'none';
                document.getElementById('call-user').innerText = "Incoming Call...";
                document.getElementById('ring').play();
                
                // Check if video or audio based on metadata (simple logic: assume video for now)
                // Or check metadata if passed. For now, default incoming UI.
                document.getElementById('voice-only').style.display = 'flex'; 
            });

            peer.on('connection', conn => {
                dataConn = conn;
                conn.on('data', d => { if(d.type === 'end') endCall(false); });
            });

            loadFriends();
            listenReq();
            setInterval(()=> db.collection('users').doc(user.uid).update({isOnline:true}), 30000);
        }

        // --- 4. CALL LOGIC (SEPARATE VIDEO/VOICE) ---
        async function makeCall(uid, name, type) {
            isVideoCall = (type === 'video');
            const constraints = {
                audio: true,
                video: isVideoCall ? { facingMode: 'user' } : false
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                if(isVideoCall) {
                    document.getElementById('local-vid').srcObject = localStream;
                    document.getElementById('local-vid').style.display = 'block';
                    document.getElementById('voice-only').style.display = 'none';
                } else {
                    document.getElementById('local-vid').style.display = 'none';
                    document.getElementById('voice-only').style.display = 'flex';
                    document.getElementById('call-user').innerText = name;
                    document.getElementById('call-status').innerText = "Calling...";
                }

                document.getElementById('call-ui').style.display = 'flex';
                document.getElementById('inc-btns').style.display = 'none';
                document.getElementById('act-btns').style.display = 'flex';
                
                const call = peer.call(uid, localStream);
                setupCall(call);

                // Sync connection
                const conn = peer.connect(uid);
                conn.on('open', ()=> { dataConn = conn; });

            } catch(e) { alert("Permission Error: " + e.message); }
        }

        async function answerCall() {
            document.getElementById('ring').pause();
            // Default to video answer if possible, or audio only
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                document.getElementById('local-vid').srcObject = localStream;
                document.getElementById('voice-only').style.display = 'none';
                
                currCall.answer(localStream);
                setupCall(currCall);
                document.getElementById('inc-btns').style.display = 'none';
                document.getElementById('act-btns').style.display = 'flex';
            } catch(e) { 
                alert("Mic/Cam Error"); endCall();
            }
        }

        function setupCall(call) {
            currCall = call;
            call.on('stream', remote => {
                document.getElementById('remote-vid').srcObject = remote;
                document.getElementById('call-status').innerText = "Connected";
                if(!isVideoCall) document.getElementById('voice-only').style.display = 'flex';
            });
            call.on('close', () => endCall(false));
        }

        function endCall(notify = true) {
            if(notify && dataConn) dataConn.send({ type: 'end' });
            if(currCall) currCall.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-ui').style.display = 'none';
            document.getElementById('ring').pause();
            document.getElementById('end').play();
        }

        function toggleMute(btn) {
            let t = localStream.getAudioTracks()[0];
            t.enabled = !t.enabled;
            btn.style.background = t.enabled ? "rgba(255,255,255,0.2)" : "red";
        }
        function toggleCam(btn) {
            let t = localStream.getVideoTracks()[0];
            if(t) {
                t.enabled = !t.enabled;
                btn.style.background = t.enabled ? "rgba(255,255,255,0.2)" : "red";
            }
        }
        async function switchCam() {
            if(localStream && isVideoCall) {
                // Basic implementation: stop old, get new with different facingMode
                // Note: requires renegotiation logic for perfect switch, simpler here
                alert("Camera Switch: Re-connect for best stability.");
            }
        }

        // --- 5. FRIENDS & SEARCH ---
        function loadFriends() {
            db.collection('users').doc(user.uid).onSnapshot(snap => {
                const list = document.getElementById('list-friends');
                list.innerHTML = "";
                (snap.data().friends || []).forEach(fid => {
                    db.collection('users').doc(fid).get().then(doc => {
                        const f = doc.data();
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="avatar">${f.emoji}</div>
                                <b>${f.name}</b>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button class="btn-icon aud-btn" onclick="makeCall('${f.uid}', '${f.name}', 'audio')"><i class="fas fa-phone"></i></button>
                                <button class="btn-icon vid-btn" onclick="makeCall('${f.uid}', '${f.name}', 'video')"><i class="fas fa-video"></i></button>
                            </div>
                        `;
                        list.appendChild(card);
                    });
                });
            });
        }
        // (Search & Request logic same as before, simplified for space)
        async function doSearch(q) {
            if(q.length<2) return;
            const res = document.getElementById('search-res');
            res.innerHTML = "";
            const snap = await db.collection('users').get();
            snap.forEach(d => {
                const u = d.data();
                if(u.uid !== user.uid && u.name.toLowerCase().includes(q.toLowerCase())) {
                    res.innerHTML += `<div class="card">${u.name} <button class="btn-sm btn" onclick="sendReq('${u.uid}')">Add</button></div>`;
                }
            });
        }
        async function sendReq(uid) {
            await db.collection('users').doc(uid).collection('requests').doc(user.uid).set({
                fromName: user.displayName || "User", fromId: user.uid
            });
            alert("Sent!");
        }
        function listenReq() {
            db.collection('users').doc(user.uid).collection('requests').onSnapshot(snap => {
                document.getElementById('req-badge').style.display = snap.empty ? 'none':'inline';
                const list = document.getElementById('list-requests');
                list.innerHTML = "";
                snap.forEach(d => {
                    list.innerHTML += `<div class="card">${d.data().fromName} <button class="btn-sm btn" onclick="accept('${d.data().fromId}', '${d.id}')">Accept</button></div>`;
                });
            });
        }
        async function accept(fid, rid) {
            await db.collection('users').doc(user.uid).update({ friends: firebase.firestore.FieldValue.arrayUnion(fid) });
            await db.collection('users').doc(fid).update({ friends: firebase.firestore.FieldValue.arrayUnion(user.uid) });
            await db.collection('users').doc(user.uid).collection('requests').doc(rid).delete();
        }

        // --- 6. GAME: SPACE GLIDER ---
        const cvs = document.getElementById('g-can'), ctx = cvs.getContext('2d');
        let frames=0, score=0, gameId=null;
        const glider = { x: 50, y: 150, v: 0, r: 10 };
        const rocks = [];

        function startGame() {
            document.getElementById('game-modal').style.display = 'flex';
            score=0; frames=0; rocks.length=0; glider.y=150; glider.v=0;
            loop();
        }
        function closeGame() { document.getElementById('game-modal').style.display = 'none'; cancelAnimationFrame(gameId); }
        
        cvs.addEventListener('click', () => glider.v = -4.5); // Jump

        function loop() {
            // Update
            glider.v += 0.15; // Gravity
            glider.y += glider.v;
            
            if(frames%100 === 0) rocks.push({x:320, y: Math.random()*400, w:30, h:30});
            rocks.forEach(r => r.x -= 2);

            // Draw
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,320,480);
            
            // Draw Glider
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
            ctx.beginPath(); ctx.arc(glider.x, glider.y, glider.r, 0, Math.PI*2); ctx.fill();

            // Draw Rocks
            ctx.fillStyle = '#ff1744';
            rocks.forEach(r => ctx.fillRect(r.x, r.y, r.w, r.h));

            // Collision
            if(glider.y > 480 || glider.y < 0) return alert("Game Over! Score: "+score), closeGame();
            rocks.forEach(r => {
                if(glider.x < r.x + r.w && glider.x + glider.r > r.x &&
                   glider.y < r.y + r.h && glider.y + glider.r > r.y) {
                    alert("Crashed! Score: "+score); closeGame();
                }
            });

            score = Math.floor(frames/50);
            document.getElementById('g-score').innerText = "Score: " + score;
            frames++;
            gameId = requestAnimationFrame(loop);
        }

        // --- 7. UTILS & THEMES ---
        function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function tab(t) { document.querySelectorAll('.list').forEach(l=>l.style.display='none'); document.getElementById('list-'+t).style.display='block'; }
        function showSettings() { const m=document.getElementById('set-modal'); m.style.display = m.style.display==='flex'?'none':'flex'; }
        
        function setTheme(n) { document.body.className = 't'+n; }
        function initParticles() {
            const c = document.getElementById('particles');
            c.innerHTML = "";
            for(let i=0; i<20; i++) {
                let p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random()*100 + '%';
                p.style.width = p.style.height = (Math.random()*20 + 10)+'px';
                p.style.animationDuration = (Math.random()*10 + 10)+'s';
                p.style.animationDelay = (Math.random()*5)+'s';
                c.appendChild(p);
            }
        }
    </script>
</body>
</html>
